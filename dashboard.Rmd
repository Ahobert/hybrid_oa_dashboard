---
title: "Open Access Hybrid Journal Monitor"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: embed
    vertical_layout: fill
  runtime: shiny
---

Overview
=================================================================


```{r setup, include=FALSE}
library(flexdashboard)
library(rio)
library(ggplot2)
library(plotly)
library(dplyr)

# access to data 
hybrid_df <- rio::import("data/cr_hybrid_df_indicators.csv") %>%
  filter(hybrid_license == TRUE) %>%
  mutate(year = factor(year, levels = c("2013", "2014", "2015","2016")))
```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r global_input}
# from https://stackoverflow.com/questions/42148177/how-can-i-build-multiple-inputs-into-my-shiny-app-with-both-updating-and-multipl
selectInput("publisherinput", "Publisher", c("All", unique(hybrid_df$publisher)), selected =
              "All")
selectInput("journalinput", "Journal", c("All", unique(hybrid_df$journal)), selected =
              "All")

jn_filtered <-
  reactive(hybrid_df[input$publisherinput == "All" |
                       hybrid_df$publisher == input$publisherinput,])

observe(updateSelectInput(
  session,
  "journalinput",
  choices = c("All", unique(jn_filtered()$journal)),
  selected = "All"
))
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
jn_f <-
  reactive(jn_filtered()[input$journalinput == "All" |
  jn_filtered()$journal == input$journalinput, ])
  
renderPlotly({
  if (length(unique(jn_f()$publisher)) > 1) {
    hybrid_sub <- jn_f() %>%
      group_by(year, licence_ref, year_all) %>%
      summarize(licence_n = sum(licence_ref_n, na.rm = TRUE)) %>%
      mutate(prop = licence_n / year_all)
  } else if (length(unique(jn_f()$journal)) > 1 &&
             length(unique(jn_f()$publisher)) == 1) {
    hybrid_sub <- jn_f() %>%
      group_by(year, licence_ref, year_publisher_all) %>%
      summarize(licence_n = sum(licence_ref_n, na.rm = TRUE)) %>%
      mutate(prop = licence_n / year_publisher_all)
  } else {
    hybrid_sub <- jn_f() %>%
      mutate(prop = as.numeric(licence_ref_n) / as.numeric(all_published))
  }
  p <- ggplot(hybrid_sub, aes(year, prop, fill = licence_ref)) +
    geom_bar(stat = "identity") +
    xlab("Year") +
    ylab("Proportion Hybrid OA / Journal Output") +
    viridis::scale_fill_viridis("Licenses", discrete = TRUE) +
    scale_x_discrete(drop = FALSE) +
    theme_minimal()
  plotly::ggplotly(p)
})
```

About
=================================================================

## This is so cool

- it is
