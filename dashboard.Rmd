---
title: "Hybrid OA Journal Monitor"
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { title: "About", href: "https://subugoe.github.io/hybrid_oa_dashboard/about.html"}
      - { title: "Data", href: "https://github.com/subugoe/hybrid_oa_dashboard/tree/master/data/README.md"}
    orientation: rows
    source_code: "https://github.com/subugoe/hybrid_oa_dashboard/"
    vertical_layout: scroll 
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(viridis)
library(tidyverse)
library(plotly)
library(scales)
library(ggalt)
library(DT)
```

```{r global}
# access to data
hybrid_df <- readr::read_csv("data/hybrid_publications.csv") %>%
  mutate(year = factor(issued, levels = c("2013", "2014", "2015","2016", "2017", "2018"))) %>% 
  arrange(desc(yearly_publisher_volume))

o_apc_df <- readr::read_csv("data/oapc_hybrid.csv") %>% 
  mutate(year = factor(period, levels = c("2013", "2014", "2015","2016", "2017", "2018")))
```

Overview
=================================================================

Inputs {.sidebar}
-----------------------------------------------------------------------


```{r}
# from https://stackoverflow.com/questions/42148177/how-can-i-build-multiple-inputs-into-my-shiny-app-with-both-updating-and-multipl

shiny::selectizeInput("publisherinput", "Publisher", c("All", unique(hybrid_df$publisher)), selected =
              "All")
shiny::selectizeInput("journalinput", "Journal", c("All", unique(hybrid_df$journal_title)), selected =
              "All", options = list(maxOptions = 5000))

# publisher filter
jn_filtered <-
  reactive(hybrid_df[input$publisherinput == "All" |
                       hybrid_df$publisher == input$publisherinput,])

observe(updateSelectInput(
  session,
  "journalinput",
  choices = c("All", sort(unique(jn_filtered()$journal_title))),
  selected = "All"
))

# journal_title filter
jn_f <-
  reactive(jn_filtered()[input$journalinput == "All" |
  jn_filtered()$journal_title == input$journalinput, ])
# prepare dataset for plotting
hybrid_sub <- reactive({
if (length(unique(jn_f()$publisher)) > 1) {
    hybrid_sub <- jn_f() %>%
      group_by(year, yearly_all, license) %>%
      count() %>%
      mutate(prop = n / yearly_all)
  } else if (length(unique(jn_f()$journal_title)) > 1 &&
             length(unique(jn_f()$publisher)) == 1) {
    hybrid_sub <- jn_f() %>%
      group_by(year, license, yearly_publisher_volume) %>%
      count() %>%  
      mutate(prop = n / yearly_publisher_volume)
  } else {
    hybrid_sub <- jn_f() %>%
      group_by(year, license, yearly_jn_volume) %>%
      count() %>%  
      mutate(prop = n / yearly_jn_volume)
  }
})

```

Notice that only those hybrid open access journals were included where 
academic institutions sponsored the publication fee according to the [Open APC initiative](https://github.com/openapc/openapc-de) 
and where publishers shared licensing information about fulltext accessibility and re-use rights 
with [Crossref](https://github.com/CrossRef/rest-api-doc).

Data sources:

<a href="https://github.com/CrossRef/rest-api-doc"><img src="https://assets.crossref.org/logo/metadata-from-crossref-logo-200.svg" width="200" height="68" alt="Metadata from Crossref logo"></a>

<a href= "https://github.com/openapc/openapc-de"><img src="https://www.intact-project.org/public/img/openAPC_01+.png" width="200"  alt="Metadata from open apc logo"></a>

Build by: <a href= "https://www.sub.uni-goettingen.de/sub-aktuell/"><img src="img/sub_logo.svg" width="200"  alt="SUB GÃ¶ttingen"></a>.

Row
-----------------------------------------------------------------------

### Publishers selected

```{r}
renderValueBox({ 
  publisher_n <- length(unique(jn_f()$publisher))
  valueBox(publisher_n, icon = "fa-filter")
})
```

### Journals selected

```{r}
renderValueBox({
  journal_n <- length(unique(jn_f()$journal_title))
  valueBox(journal_n, icon = "fa-filter")
})
```

### Hybrid OA articles indexed in Crossref

```{r}
renderValueBox({
  hybrid_n <- nrow(jn_f())
  valueBox(hybrid_n, icon = "fa-creative-commons")
})
```


Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Hybrid OA Licenses found (relative)

```{r}
renderPlotly({
  p <- ggplot(hybrid_sub(), aes(year, prop, fill = license)) +
    geom_bar(stat = "identity") +
    xlab("Year") +
    ylab("Hybrid OA / Articles published") +
    viridis::scale_fill_viridis("Licenses", discrete = TRUE) +
    scale_x_discrete(drop = FALSE) +
    scale_y_continuous(labels = scales::percent) +
    theme_minimal()
 plotly::ggplotly(p) %>%
    layout(showlegend = TRUE, legend = list(font = list(size = 9)))
})
```


### Hybrid OA Licenses found (absolute)

```{r}
renderPlotly({
  p <- ggplot(hybrid_sub(), aes(year, n, fill = license)) +
    geom_bar(stat = "identity") +
    xlab("Year") +
    ylab("Hybrid OA Articles") +
    viridis::scale_fill_viridis("Licenses", discrete = TRUE) +
    scale_x_discrete(drop = FALSE) +
    scale_y_continuous(labels=function(x) format(x, big.mark = " ", scientific = FALSE),
                       breaks= pretty_breaks()) +
    theme_minimal()
  plotly::ggplotly(p) %>%
    layout(showlegend = TRUE, legend = list(font = list(size = 9)))
})
```

Row {data-width=400 data-height=350}
-------------------------------------

### Crossref Indexing Coverage vs Spending Information available via Open APC

```{r}
renderPlotly({
  hybrid_sub <- hybrid_sub() %>%
    group_by(year) %>% 
    summarise(n = sum(n)) %>%
    mutate(source = "Crossref Hybrid")
  
  o_apc_sub <- o_apc_df %>%
    filter(journal_full_title %in% jn_f()$journal_title) %>%
    count(year, hybrid_type)
  
  p <-
    ggplot(hybrid_sub, aes(year, n, fill = source)) +
    geom_bar(stat = "identity") +
    xlab("Year") +
    ylab("Articles") +
    scale_x_discrete(drop = FALSE) +
    viridis::scale_fill_viridis("Datasets", discrete = TRUE) +
    scale_y_continuous(
      labels = function(x)
        format(x, big.mark = " ", scientific = FALSE),
      breaks = pretty_breaks()
    ) +
    theme_minimal()
  p <-
    p + geom_bar(
      data = o_apc_sub,
      aes(year, n, fill = hybrid_type),
      stat = "identity",
      alpha = 0.8
    )
  
  tt <- plotly::ggplotly(p, tooltip = c("y")) %>%
    layout(showlegend = TRUE, legend = list(font = list(size = 10)))
  tt$x$data <- lapply(tt$x$data, function(x) {
    x$text <- paste(x$name, x$y, sep = ": ")
    x
  })
  tt
})
```


### Institutional Spending per Country (in percent)

```{r}
renderPlot({
tt <- o_apc_df %>%
    filter(journal_full_title %in% jn_f()$journal_title) %>%
    count(country) %>% 
  mutate(prop = n / sum(n))
gg <- ggplot(tt, aes(prop, reorder(country, prop))) +
  ggalt::geom_lollipop(point.colour="steelblue", point.size=4, horizontal=TRUE) +
  scale_x_continuous(expand=c(0,0), labels=percent,
                              breaks=seq(0, 1, by=0.2), limits=c(0, 1)) +
  labs(x = NULL, y = NULL) +
  #  title="Institutional spending on hybrid OA journal_title articles",
  #  subtitle="Articles funded per country (in percent)",
  theme_minimal() +
  theme(panel.grid.major.y=element_blank()) +
  theme(panel.grid.minor=element_blank()) +
  theme(axis.line.y=element_line(color="#2b2b2b", size=0.15)) +
  theme(axis.text.y=element_text(margin=margin(r=0, l=0))) +
  theme(plot.margin=unit(rep(30, 4), "pt")) +
  theme(plot.title=element_text(face="bold")) +
  theme(plot.subtitle=element_text(margin=margin(b=10))) +
  theme(plot.caption=element_text(size=8, margin=margin(t=10)))
gg})
```

Compare 
=====================================

Row
--------------------------------------------


### Proportion of open access publications in subscription-based journals by publisher 


```{r}
fillCol(height = 600, flex = c(NA, 1), 
        inputPanel(
          selectInput(
            "Year",
            label = "Select Year",
            choices = c(rev(levels(hybrid_df$year))),
            selected = "2017",
            multiple = TRUE
    ),
    checkboxInput("rb", "Display journals", FALSE)),
  plotlyOutput("pubplot", height = "100%")
)

output$pubplot <- renderPlotly({
  if(input$Year == "All") {
    tt <-   hybrid_df %>%
      filter(!is.na(license)) %>%
      mutate(publisher = forcats::as_factor(publisher)) %>%
      group_by(year, publisher, journal_title, yearly_jn_volume) %>%
      summarize(oa = n()) %>%
      mutate(prop = oa / yearly_jn_volume)
  } else {
    tt <-  hybrid_df %>%
      filter(!is.na(license)) %>%
      mutate(publisher = forcats::as_factor(publisher)) %>%
      filter(year %in% input$Year) %>%
      group_by(year, publisher, journal_title, yearly_jn_volume) %>%
      summarize(oa = n()) %>%
      mutate(prop = oa / yearly_jn_volume)
  }
  tt <- tt %>%
    ungroup() %>%
    mutate(publisher = forcats::fct_other(publisher, keep = levels(publisher)[1:10]))
  p <- ggplot(tt, aes(y = prop, x = as.factor(publisher))) +
  geom_boxplot() + 
   coord_flip() +
   theme_minimal() +
   xlab("Publisher") +
   ylab(NULL) +
   scale_x_discrete(drop = FALSE, limits = rev(levels(tt$publisher)),
                    labels = function(x) str_wrap(x, width = 30)) +
   scale_y_continuous(labels = scales::percent) 
 if (input$rb == TRUE) {
   p <- p +
     geom_point(aes(colour = prop, label = journal_title)) +
     scale_colour_viridis(option = "C") +
     scale_fill_viridis(option = "C") +
     guides(color = FALSE, fill = FALSE)
 } else {
   p <- p
 }
 plotly::ggplotly(p, tooltip = c("label", "y")) %>%
   layout(margin = list(l = 200))
})
```


### Proportion of open access publications in subscription-based journals by year 

```{r}
fillCol(height = 600, flex = c(NA, 1), 
        inputPanel(
          selectInput(
            "Publisher",
            label = "Select Publisher",
            choices = c("All", unique(hybrid_df$publisher)),
            selected = "All"
    )),
  plotlyOutput("yearplot", height = "100%")
)

output$yearplot <- renderPlotly({
  if(input$Publisher == "All") {
    tt <-   hybrid_df %>%
      filter(!is.na(license)) %>%
      group_by(year, publisher, journal_title, yearly_jn_volume) %>%
      summarize(oa = n()) %>%
      mutate(prop = oa / yearly_jn_volume)
  } else {
    tt <-  hybrid_df %>%
      filter(!is.na(license)) %>%
      filter(publisher == input$Publisher) %>%
      group_by(year, publisher, journal_title, yearly_jn_volume) %>%
      summarize(oa = n()) %>%
      mutate(prop = oa / yearly_jn_volume)
  }
   
  p <- ggplot(tt, aes(y = prop, x = as.factor(year))) +
  geom_boxplot() + 
   coord_flip() +
   theme_minimal() +
   xlab("Year") +
   ylab(NULL) +
   scale_x_discrete(drop = FALSE) +
   scale_y_continuous(labels = scales::percent)
 if (input$rb == TRUE) {
   p <- p +
     geom_point(aes(colour = prop, label = journal_title)) +
     scale_colour_viridis(option = "C") +
     scale_fill_viridis(option = "C") +
     guides(color = FALSE, fill = FALSE)
 } else {
   p <- p
 }
 plotly::ggplotly(p, tooltip = c("label", "y"))
})
```


Row 
---------------------------------------------

### Table view {data-height=700}

```{r}
renderDataTable({
  if(input$Publisher == "All") {
    hybrid_df
  } else {
    hybrid_df <- hybrid_df %>%
      filter(publisher == input$Publisher)
  }
  hybrid_df %>%
    filter(year %in% input$Year) %>%
    group_by(year, publisher, journal_title, yearly_jn_volume) %>%
    summarize(oa = n()) %>%
    mutate(prop = round((oa / yearly_jn_volume) * 100, 2)) %>%
    arrange(desc(year))},
  colnames = c('Year', 'Publisher', 'Journal', 'Article Volume', 'OA Articles', 'OA Share (in %)'),
  rownames = FALSE, 
  filter = 'bottom',
  options = list(
          pageLength = 10,
          lengthMenu = c(5,10,25,50),
  columnDefs = list(list(className = 'dt-head-left', targets = "_all"))))
```

